# 02-load-patterns: 負荷パターン

k6で実施できる主要な負荷テストパターンを学ぶためのシナリオ集です。それぞれのテストパターンには明確な目的があり、適切なタイミングで実施することが重要です。

## 📊 負荷テストの種類と使い分け

| テスト種類 | VU数 | 実行時間 | 目的 | 本番実施 |
|-----------|------|---------|------|---------|
| Smoke Test | 1-2 | 1-5分 | 基本動作確認 | ✅ 可能 |
| Load Test | 10-100 | 5-30分 | 通常負荷での性能測定 | ⚠️ 注意 |
| Stress Test | 50-200+ | 10-30分 | 限界点の把握 | ❌ 不可 |
| Spike Test | 10→200 | 5-15分 | 急激な負荷変動への対応 | ❌ 不可 |
| Soak Test | 10-50 | 数時間-数日 | 長時間稼働の安定性 | ❌ 不可 |
| Breakpoint Test | 段階的増加 | 20-60分 | 破綻点の特定 | ❌ 不可 |

## 📚 シナリオ一覧

### 01-smoke-test.js - スモークテスト

**目的:** 最小限の負荷でシステムが正常に動作することを確認

**設定:**
- VU: 1
- 実行時間: 2分

**閾値:**
- 失敗率: 1%未満
- レスポンスタイム（p95）: 200ms未満
- Check成功率: 99%以上

**実行方法:**
```bash
k6 run scenarios/02-load-patterns/01-smoke-test.js
```

**いつ使う:**
- デプロイ前の最終チェック
- 新機能のリリース前
- 他の負荷テストの前段階として

**判定:**
- ✅ 合格 → 次のテスト（ロードテスト）に進む
- ❌ 不合格 → 問題を修正してから再実行

---

### 02-load-test.js - ロードテスト

**目的:** 通常運用時の負荷でシステムのパフォーマンスを測定

**設定:**
- VU: 10 → 20（段階的）
- 実行時間: 16分

**閾値:**
- 失敗率: 5%未満
- レスポンスタイム（p95）: 500ms未満
- レスポンスタイム（p99）: 1000ms未満
- Check成功率: 95%以上

**実行方法:**
```bash
k6 run scenarios/02-load-patterns/02-load-test.js
```

**いつ使う:**
- システムの通常動作を検証したいとき
- パフォーマンスベースラインを確立したいとき
- 定期的なパフォーマンステストとして

**分析ポイント:**
- レスポンスタイムの分布（p50, p95, p99）
- エラー率の推移
- スループット（requests/sec）

---

### 03-stress-test.js - ストレステスト

**目的:** システムの限界点を見極める

**設定:**
- VU: 20 → 50 → 100（段階的増加）
- 実行時間: 26分

**閾値:**
- 失敗率: 10%未満
- レスポンスタイム（p95）: 2000ms未満

**実行方法:**
```bash
k6 run scenarios/02-load-patterns/03-stress-test.js
```

**いつ使う:**
- システムの耐久性を確認したいとき
- キャパシティプランニング
- ピーク時の挙動を予測したいとき

**観察ポイント:**
1. どの時点でレスポンスタイムが劣化し始めるか
2. どの時点でエラー率が上昇するか
3. 負荷が下がった後、システムが正常に回復するか

**⚠️ 注意:**
- 本番環境では実行しないこと
- システム監視を並行して行うこと

---

### 04-spike-test.js - スパイクテスト

**目的:** 急激な負荷変動に対するシステムの反応を確認

**設定:**
- VU: 10 → 🚀200（急増）→ 10
- スパイク時間: 3分
- 実行時間: 8分

**閾値:**
- 失敗率: 15%未満
- レスポンスタイム（p99）: 5000ms未満

**実行方法:**
```bash
k6 run scenarios/02-load-patterns/04-spike-test.js
```

**いつ使う:**
- フラッシュセールやイベント時の対策
- SNSでのバズを想定
- オートスケーリングのテスト

**観察ポイント:**
1. スパイク発生時のレスポンスタイム
2. エラー率の変化
3. オートスケーリングが発動するか
4. レートリミットやキューイングの動作
5. スパイク後の回復時間

**期待される挙動:**
- ✅ エラー率は一時的に上昇するが、致命的にはならない
- ✅ レスポンスタイムは劣化するが、許容範囲内
- ✅ スパイク後、正常な状態に回復する
- ✅ システムがクラッシュしない

---

### 05-soak-test.js - ソークテスト

**目的:** 長時間の継続的な負荷でシステムの安定性を確認

**設定:**
- VU: 20（一定）
- 実行時間: 1時間（本番では数時間～数日）

**閾値:**
- 失敗率: 1%未満
- レスポンスタイム（p95）: 500ms未満
- レスポンスタイム（p99）: 1000ms未満
- Check成功率: 99%以上

**実行方法:**
```bash
# テスト用（1時間）
k6 run scenarios/02-load-patterns/05-soak-test.js

# 本番用（6時間）- stagesを変更してから実行
k6 run scenarios/02-load-patterns/05-soak-test.js
```

**いつ使う:**
- 本番リリース前の最終確認
- 長時間稼働時の安定性確認
- メモリリークの検出

**監視ポイント:**
1. メモリ使用量が徐々に増加していないか（メモリリーク）
2. CPU使用率が安定しているか
3. データベース接続数が増加し続けていないか
4. ディスク使用量（ログファイルなど）
5. レスポンスタイムが時間経過で劣化していないか

**⚠️ 注意:**
- システムの監視を必ず並行して行うこと
- ログのローテーション設定を確認すること
- ステージング環境での実施を推奨

---

### 06-breakpoint-test.js - ブレークポイントテスト

**目的:** システムが破綻する具体的なポイントを特定

**設定:**
- VU: 0 → 20 → 40 → ... → 200（段階的増加）
- 各ステージ: 2分
- 実行時間: 約21分

**閾値:**
- 失敗率: 50%未満（破綻判定）
- レスポンスタイム（p99）: 10000ms未満

**実行方法:**
```bash
k6 run scenarios/02-load-patterns/06-breakpoint-test.js
```

**いつ使う:**
- システムの限界を正確に知りたいとき
- スケーリング計画を立てるとき
- インフラのサイジング決定時

**結果の分析:**
1. レスポンスタイムのグラフ → どの時点から急激に劣化するか
2. エラー率のグラフ → どの時点からエラーが増加するか
3. スループット → どの時点で頭打ちになるか
4. システムメトリクス → リソースの限界点

**例:**
- 80 VUまでは安定
- 100 VUで劣化開始
- 120 VUで破綻

→ ブレークポイントは100 VU  
→ 安全な運用は80 VU以下を推奨

**⚠️ 注意:**
- 必ずテスト環境で実施すること
- システム監視を必ず並行して行うこと

---

## 🎯 推奨テストフロー

```
1. Smoke Test （基本動作確認）
   ↓ ✅ 合格
2. Load Test （通常負荷での性能測定）
   ↓ ✅ 合格
3. Stress Test （限界点の把握）
   ↓
4. Spike Test （急激な負荷変動への対応）
   ↓
5. Soak Test （長時間稼働の安定性）
   ↓
6. Breakpoint Test （破綻点の特定）
```

## 📈 メトリクスの見方

### 主要メトリクス

**http_req_duration**
- リクエストの所要時間
- `avg`: 平均値
- `min/max`: 最小値/最大値
- `p(90), p(95), p(99)`: パーセンタイル（重要）

**http_req_failed**
- リクエストの失敗率
- `rate`: 失敗率（0.05 = 5%）

**http_reqs**
- 総リクエスト数
- スループットの指標

**iterations**
- 完了したイテレーション数

**checks**
- 検証の成功率

### パーセンタイルとは

- `p(50)`: 50%のユーザーがこの値以下を経験（中央値）
- `p(95)`: 95%のユーザーがこの値以下を経験
- `p(99)`: 99%のユーザーがこの値以下を経験

例: `p(95) = 500ms` → 95%のリクエストが500ms以下でレスポンス

## 🔧 トラブルシューティング

### モックサーバーが起動しない

```bash
docker compose up -d
docker ps | grep k6
curl http://localhost:3000/health
```

### テストが途中で失敗する

- システムリソースを確認（CPU、メモリ）
- モックサーバーのログを確認: `docker logs k6-sandbox-mock-server`
- 閾値を緩めて再実行

### k6がインストールされていない

```bash
# macOS
brew install k6

# または Docker
docker run --rm -i --network=host grafana/k6 run - < scenarios/02-load-patterns/01-smoke-test.js
```

## 💡 ベストプラクティス

1. **必ずスモークテストから始める**
   - 基本動作を確認してから高負荷テストに進む

2. **段階的に負荷を上げる**
   - いきなり高負荷をかけない

3. **システム監視を並行して行う**
   - k6のメトリクスだけでなく、サーバー側も監視

4. **本番環境では慎重に**
   - Smoke Test以外は基本的にステージング環境で実施

5. **結果を記録して比較する**
   - パフォーマンスの変化を追跡

6. **ボトルネックを特定する**
   - CPU、メモリ、DB、ネットワークのどこがボトルネックか
